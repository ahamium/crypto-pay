name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write # GHCR push
  id-token: write

jobs:
  # 1) Lint + Test + Build (+ blockchain test)
  test-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ---- Lint ----
      - name: Lint all packages
        run: pnpm lint

      # ---- Tests (backend + frontend + blockchain) ----
      - name: Run tests
        run: pnpm test

      # (옵션) Solidity coverage
      - name: Solidity coverage (blockchain)
        run: |
          cd blockchain
          pnpm coverage
        continue-on-error: true

      # ---- Build (typecheck + prod build) ----
      - name: Build all packages
        run: pnpm build

      # (옵션) 커버리지 아티팩트 업로드 (Jest, solidity-coverage 등)
      - name: Upload coverage artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            backend/coverage
            frontend/coverage
            blockchain/coverage
          if-no-files-found: ignore

  # 2) Docker 이미지 빌드 & 푸시 (main 브랜치, 테스트 통과 후)
  docker:
    needs: test-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # main push일 때만 실행

    env:
      REGISTRY: ghcr.io
      IMAGE_BACKEND: ${{ github.repository }}-backend
      IMAGE_FRONTEND: ${{ github.repository }}-frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image
        run: |
          docker build \
            -f backend/Dockerfile \
            -t $REGISTRY/${IMAGE_BACKEND}:sha-${{ github.sha }} \
            backend

      - name: Build frontend image
        run: |
          docker build \
            -f frontend/Dockerfile \
            -t $REGISTRY/${IMAGE_FRONTEND}:sha-${{ github.sha }} \
            frontend

      - name: Push images
        run: |
          docker push $REGISTRY/${IMAGE_BACKEND}:sha-${{ github.sha }}
          docker push $REGISTRY/${IMAGE_FRONTEND}:sha-${{ github.sha }}

      # (옵션) latest 태그도 함께 관리하고 싶으면
      # - name: Tag & push latest
      #   run: |
      #     docker tag $REGISTRY/${IMAGE_BACKEND}:sha-${{ github.sha }} $REGISTRY/${IMAGE_BACKEND}:latest
      #     docker tag $REGISTRY/${IMAGE_FRONTEND}:sha-${{ github.sha }} $REGISTRY/${IMAGE_FRONTEND}:latest
      #     docker push $REGISTRY/${IMAGE_BACKEND}:latest
      #     docker push $REGISTRY/${IMAGE_FRONTEND}:latest
